@page "/calculator"
@using NCalc

@inject ISnackbar Snackbar

<style>
    .monofield {
        font-family: 'Roboto Mono', monospace;
    }
</style>

<MudGrid Class="pa-2" Spacing="1">
    <MudItem xs="12" md="6">
        <MudField Variant="Variant.Filled" Label="Калькулятор режимов" Underline="false">
            <MudGrid>
                <MudItem xs="6">
                    <MudTextField @bind-Value="DiameterString" InputMode="inputMode" T="string" Label="Диаметр" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="мм" Immediate="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @bind-Value="EdgesString" InputMode="inputMode" T="string" Label="Зубья" Variant="Variant.Text" Immediate="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @bind-Value="CutSpeedString" @onfocusin="@(() => CalcSpins = true)" InputMode="inputMode" T="string" Label="Скорость" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="м/мин" Immediate="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @bind-Value="FeedString" @onfocusin="@(() => CalcMinFeed = true)" InputMode="inputMode" T="string" Label="Подача" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="@FeedUnits" Immediate="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @bind-Value="SpindleSpeedString" @onfocusin="@(() => CalcSpins = false)" InputMode="inputMode" T="string" Label="Обороты" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="об/мин" Immediate="true" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @bind-Value="MinFeedString" @onfocusin="@(() => CalcMinFeed = false)" InputMode="inputMode" T="string" Label="Подача" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="мм/мин" Immediate="true" />
                </MudItem>
            </MudGrid>
        </MudField>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudField Variant="Variant.Filled" Label="Калькулятор" Underline="false">
            <MudGrid>
                <MudItem xs="12">
                    <MudGrid Spacing="0">
                        <MudItem xs="12">
                            <MudTextField Margin="Margin.Dense" Label="Выражение" @bind-Value="UserExpression" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Margin="Margin.Dense" Label="Результат" @bind-Value="Answer" />
                        </MudItem>
                    </MudGrid>
                </MudItem>

                <MudItem xs="12">
                    <MudGrid Spacing="1">
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => UserExpression = string.Empty)">C</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("/"))">/</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("*"))">×</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="EraseLeftExpr">⌫</MudButton>
                        </MudItem>

                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("7"))">7</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("8"))">8</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("9"))">9</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("-"))">-</MudButton>
                        </MudItem>

                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("4"))">4</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("5"))">5</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("6"))">6</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("+"))">+</MudButton>
                        </MudItem>

                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("1"))">1</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("2"))">2</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("3"))">3</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("%"))">%</MudButton>
                        </MudItem>

                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("3.1416"))">Pi</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("0"))">0</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="@(() => AddToExpr("."))">.</MudButton>
                        </MudItem>
                        <MudItem xs="3">
                            <MudButton Size="Size.Large" Variant="Variant.Outlined" FullWidth="true" OnClick="Calculate"
                                ButtonType="ButtonType.Submit" Color="Color.Primary">=</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudItem>
            </MudGrid>
        </MudField>
    </MudItem>
</MudGrid>

@code
{
    InputMode inputMode = InputMode.@decimal;
    public bool CalcSpins { get; set; } = true;
    public bool CalcMinFeed { get; set; } = true;

    private const string RadianToDegreeFunction = "Deg";
    private const string DegreeToRadianFunction = "Rad";

    #region Диаметр

    private string diameterString = String.Empty;

    public string DiameterString
    {
        get => diameterString;
        set
        {
            diameterString = value;
            if(Diameter > 0)
            {
                if (CalcSpins)
                {
                    SpindleSpeedString = Util.ToPrettyString((CutSpeed * 1000) / (Diameter * Math.PI), 0);
                }
                else if (!CalcSpins)
                {
                    CutSpeedString = Util.ToPrettyString((Diameter * Math.PI * SpindleSpeed) / 1000);
                }
            }
        }
    }

    public double Diameter => Util.GetDouble(DiameterString, 0);

    #endregion

    #region Скрость резания
    private string cutSpeedstring = String.Empty;

    public string CutSpeedString
    {
        get => cutSpeedstring;
        set
        {
            cutSpeedstring = value;
            if (CalcSpins)
            {
                SpindleSpeedString = Util.ToPrettyString((CutSpeed * 1000) / (Diameter * Math.PI), 0);
            }
            if (CalcMinFeed)
            {
                MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
            }
            else if (!CalcMinFeed)
            {
                FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
            }
        }
    }

    public double CutSpeed => Util.GetDouble(CutSpeedString, 0);

    #endregion

    #region Обороты
    private string spingleSpeedString = String.Empty;

    public string SpindleSpeedString
    {
        get => spingleSpeedString;
        set
        {
            spingleSpeedString = value;
            if(Diameter > 0)
            {
                if (!CalcSpins)
                {
                    CutSpeedString = Util.ToPrettyString((Diameter * Math.PI * SpindleSpeed) / 1000, 0);
                }
                if (CalcMinFeed)
                {
                    MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
                }
                else if (!CalcMinFeed)
                {
                    FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
                }
            }
        }
    }

    public double SpindleSpeed => Util.GetDouble(SpindleSpeedString, 0);

    #endregion

    #region Зубья
    private string egdesString = String.Empty;

    public string EdgesString
    {
        get => egdesString;
        set
        {
            egdesString = value;
            if (CalcMinFeed)
            {
                MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
            }
            else if (!CalcMinFeed)
            {
                FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
            }
        }
    }

    public int Edges => Util.GetInt(EdgesString, 1);

    #endregion

    public string FeedUnits => Edges > 1 ? "мм/зуб" : "мм/об";

    #region Подача
    private string feedString = String.Empty;

    public string FeedString
    {
        get => feedString;
        set
        {
            feedString = value;
            if (CalcMinFeed)
            {
                MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
            }
        }
    }
    public double Feed => Util.GetDouble(FeedString);

    #endregion

    #region Минутная подача
    private string minFeedString = String.Empty;

    public string MinFeedString
    {
        get => minFeedString;
        set
        {
            minFeedString = value;
            if (!CalcMinFeed)
            {
                FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
            }
        }
    }

    public double MinFeed => Util.GetDouble(MinFeedString);

    #endregion

    public string CalcInfo { get
        {
            string text = string.Empty;
            if (CalcSpins && Diameter > 0 && CutSpeed > 0)
            {
                text += $"Обороты: ({CutSpeed.ToPrettyString()}*1000)/(π*{Diameter}) = {Util.ToPrettyString((CutSpeed * 1000) / (Diameter * Math.PI), 0)} об/мин";
            }
            if (!CalcSpins && Diameter > 0 && SpindleSpeed > 0)
            {
                text += $"Скорость: π*{Diameter}*{SpindleSpeed}/1000 = {Util.ToPrettyString((Diameter * Math.PI * SpindleSpeed) / 1000, 0)} м/мин";
            }
            if (CalcMinFeed && Diameter > 0 && SpindleSpeed > 0 && Feed > 0)
            {
                text += Edges == 1
                    ? $"\nПодачу: {Feed.ToPrettyString()}*{SpindleSpeed} = {Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0)} мм/мин"
                    : $"\nПодачу: {Feed.ToPrettyString()}*{SpindleSpeed}*{Edges} = {Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0)} мм/мин";
            }
            if (!CalcMinFeed && Diameter > 0 && SpindleSpeed > 0 && MinFeed > 0)
            {
                text += Edges == 1
                    ? $"\nПодачу: {MinFeed}/{SpindleSpeed} = {Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3)} {FeedUnits}"
                    : $"\nПодачу: {MinFeed}/{SpindleSpeed}*{Edges} = {Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3)} {FeedUnits}";
            }
            return text;
        }
        set { }
    }

    public string Answer { get; set; } = "";
    public string UserExpression { get; set; } = "";

    void AddToExpr(string text) => UserExpression += text;

    void EraseLeftExpr()
    {
        if (UserExpression.Length > 0) UserExpression = UserExpression[..^1];
    }

    void ClearCalculator()
    {
        UserExpression = string.Empty;
        Answer = string.Empty;
    }

    void Calculate()
    {
        List<string> calcErrors = new();
        try
        {
            var expr = new Expression(UserExpression.Replace(',', '.'), ExpressionOptions.IgnoreCaseAtBuiltInFunctions | ExpressionOptions.CaseInsensitiveStringComparer);
            expr.Functions[DegreeToRadianFunction] = (args) =>
                {
                    if (args.Count() > 1) Util.ThrowLogged<ArgumentOutOfRangeException>($"Слишком много аргументов для функции {DegreeToRadianFunction}", calcErrors);
                    double d = args[0].Evaluate() switch
                    {
                        double dd => dd,
                        int ii => ii,
                        long ll => ll,
                        string ss => Util.ToDouble(ss.Replace(',', '.')),
                        _ => throw new ArgumentException($"Неподдерживаемый тип: {args?.GetType()}")
                    };
                    return d * Math.PI / 180;
                };

            expr.Functions[RadianToDegreeFunction] = (args) =>
            {
                if (args.Count() > 1) Util.ThrowLogged<ArgumentOutOfRangeException>($"Слишком много аргументов для функции {RadianToDegreeFunction}", calcErrors);
                double d = args[0].Evaluate() switch
                {
                    double dd => dd,
                    int ii => ii,
                    long ll => ll,
                    string ss => Util.ToDouble(ss.Replace(',', '.')),
                    _ => Util.ThrowLogged<ArgumentException>($"Неподдерживаемый тип: {args?.GetType()}", calcErrors),
                };
                return d * 180 / Math.PI;
            };
            if (expr.HasErrors())
            {
                Snackbar.Add(expr.Error.Message);
                return;
            }
            var r = expr.Evaluate();
            if (r is null)
            {
                Snackbar.Add("Не удалось вычислить");
                return;
            }

            Answer = r is double d ? d.ToString("0.###").Replace(',', '.') :
                     r is int i ? i.ToString() :
                     r is long l ? l.ToString() :
                     r?.ToString() ?? "[?]";
            return;
        }
        catch
        {
            Snackbar.Add($"Ошибки при вычислении: {string.Join(", ", calcErrors)}");
        }
    }
}
