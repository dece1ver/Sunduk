@page "/calculator"
@using NCalc
@using Sunduk.PWA.Infrastructure.Extensions
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<style>
    .monofield {
        font-family: 'Roboto Mono', monospace;
    }
</style>

<MudGrid Class="pa-2" Spacing="1">
    <MudItem xs="12" md="6">
        <MudField Variant="Variant.Filled" Label="Калькулятор режимов" Underline="false">
            <MudGrid>
                <MudItem xs="6">
                    <MudTextField @ref="diameterField" @bind-Value="DiameterString" InputId="calculator-diameter" InputMode="inputMode" T="string" Label="Диаметр" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="мм" Immediate="true" @onfocus="() => UpdateCursorPositionOnFocus(diameterField)" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @ref="edgesField" @bind-Value="EdgesString" InputId="calculator-edges" InputMode="inputMode" T="string" Label="Зубья" Variant="Variant.Text" Immediate="true" @onfocus="() => UpdateCursorPositionOnFocus(edgesField)" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @ref="cutSpeedField" @bind-Value="CutSpeedString" InputId="calculator-cutSpeed" @onfocusin="@(() => CalcSpins = true)" InputMode="inputMode" T="string" Label="Скорость" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="м/мин" Immediate="true" @onfocus="() => UpdateCursorPositionOnFocus(cutSpeedField)" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @ref="feedField" @bind-Value="FeedString" InputId="calculator-feed" @onfocusin="@(() => CalcMinFeed = true)" InputMode="inputMode" T="string" Label="Подача" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="@FeedUnits" Immediate="true" @onfocus="() => UpdateCursorPositionOnFocus(feedField)" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @ref="spindleSpeedField" @bind-Value="SpindleSpeedString" InputId="calculator-spindleSpeed" @onfocusin="@(() => CalcSpins = false)" InputMode="inputMode" T="string" Label="Обороты" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="об/мин" Immediate="true" @onfocus="() => UpdateCursorPositionOnFocus(spindleSpeedField)" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @ref="minFeedField" @bind-Value="MinFeedString" InputId="calculator-minFeed" @onfocusin="@(() => CalcMinFeed = false)" InputMode="inputMode" T="string" Label="Подача" Variant="Variant.Text" Adornment="Adornment.End" AdornmentText="мм/мин" Immediate="true" @onfocus="() => UpdateCursorPositionOnFocus(minFeedField)" />
                </MudItem>
            </MudGrid>
        </MudField>
    </MudItem>
    <MudItem xs="12" md="6">
        <MudField Variant="Variant.Filled" Label="Калькулятор" Underline="false">
            <MudGrid>
                <MudItem xs="12">
                    <MudGrid Spacing="0">
                        <MudItem xs="12">
                            <MudTextField @ref="exprField" InputId="calculator-expression" Margin="Margin.Dense" Label="Выражение" @bind-Value="UserExpression" InputMode="inputMode" @onfocus="() => UpdateCursorPositionOnFocus(exprField)" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField Margin="Margin.Dense" Label="Результат" @bind-Value="Answer" ReadOnly="true" />
                        </MudItem>
                    </MudGrid>
                </MudItem>

                <MudItem xs="12">
                    <MudGrid Spacing="1">

                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => CalculateTrigonometricFunction(TrigonometricFunction.Sin))">Sin</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("²"))">X²</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("/"))">/</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("*"))">×</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(ClearCalculator)">C</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="EraseLeftExpr">⌫</MudButton>
                        </MudItem>

                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => CalculateTrigonometricFunction(TrigonometricFunction.Cos))">Cos</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => { })">√X</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("7"))">7</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("8"))">8</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("9"))">9</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("-"))">−</MudButton>
                        </MudItem>

                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => CalculateTrigonometricFunction(TrigonometricFunction.Tan))">Tan</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("^"))">Xⁿ</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("4"))">4</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("5"))">5</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("6"))">6</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("+"))">+</MudButton>
                        </MudItem>

                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => CalculateTrigonometricFunction(TrigonometricFunction.Atan))">ATAN</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("𝜋"))">𝜋</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("1"))">1</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("2"))">2</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("3"))">3</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("%"))">%</MudButton>
                        </MudItem>

                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr("("))">(</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="@(() => AddToExpr(")"))">)</MudButton>
                        </MudItem>
                        <MudItem xs="4">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("0"))">0</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" style="background-color: #323232;" FullWidth="true" OnClick="@(() => AddToExpr("."))">.</MudButton>
                        </MudItem>
                        <MudItem xs="2">
                            <MudButton Size="Size.Large" Variant="Variant.Filled" FullWidth="true" OnClick="Calculate"
                                       ButtonType="ButtonType.Submit" Color="Color.Primary">=</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudItem>
            </MudGrid>
        </MudField>
    </MudItem>
</MudGrid>

@code
{
    InputMode inputMode = InputMode.@decimal;
    public bool CalcSpins { get; set; } = true;
    public bool CalcMinFeed { get; set; } = true;

    private const string RadianToDegreeFunction = "Deg";
    private const string DegreeToRadianFunction = "Rad";

    // Ссылки на поля ввода
    private MudTextField<string>? diameterField;
    private MudTextField<string>? edgesField;
    private MudTextField<string>? cutSpeedField;
    private MudTextField<string>? feedField;
    private MudTextField<string>? spindleSpeedField;
    private MudTextField<string>? minFeedField;
    private MudTextField<string>? exprField;
    private MudTextField<string>? activeField;

    enum TrigonometricFunction
    {
        Sin,
        Cos,
        Tan,
        Atan
    }

    #region Диаметр

    private string diameterString = String.Empty;

    public string DiameterString
    {
        get => diameterString;
        set
        {
            diameterString = value;
            if (Diameter > 0)
            {
                if (CalcSpins)
                {
                    SpindleSpeedString = Util.ToPrettyString((CutSpeed * 1000) / (Diameter * Math.PI), 0);
                }
                else if (!CalcSpins)
                {
                    CutSpeedString = Util.ToPrettyString((Diameter * Math.PI * SpindleSpeed) / 1000);
                }
            }
        }
    }

    public double Diameter => Util.GetDouble(DiameterString, 0);

    #endregion

    #region Скрость резания
    private string cutSpeedstring = String.Empty;

    public string CutSpeedString
    {
        get => cutSpeedstring;
        set
        {
            cutSpeedstring = value;
            if (CalcSpins)
            {
                SpindleSpeedString = Util.ToPrettyString((CutSpeed * 1000) / (Diameter * Math.PI), 0);
            }
            if (CalcMinFeed)
            {
                MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
            }
            else if (!CalcMinFeed)
            {
                FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
            }
        }
    }

    public double CutSpeed => Util.GetDouble(CutSpeedString, 0);

    #endregion

    #region Обороты
    private string spingleSpeedString = String.Empty;

    public string SpindleSpeedString
    {
        get => spingleSpeedString;
        set
        {
            spingleSpeedString = value;
            if (Diameter > 0)
            {
                if (!CalcSpins)
                {
                    CutSpeedString = Util.ToPrettyString((Diameter * Math.PI * SpindleSpeed) / 1000, 0);
                }
                if (CalcMinFeed)
                {
                    MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
                }
                else if (!CalcMinFeed)
                {
                    FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
                }
            }
        }
    }

    public double SpindleSpeed => Util.GetDouble(SpindleSpeedString, 0);

    #endregion

    #region Зубья
    private string egdesString = String.Empty;

    public string EdgesString
    {
        get => egdesString;
        set
        {
            egdesString = value;
            if (CalcMinFeed)
            {
                MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
            }
            else if (!CalcMinFeed)
            {
                FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
            }
        }
    }

    public int Edges => Util.GetInt(EdgesString, 1);

    #endregion

    public string FeedUnits => Edges > 1 ? "мм/зуб" : "мм/об";

    #region Подача
    private string feedString = String.Empty;

    public string FeedString
    {
        get => feedString;
        set
        {
            feedString = value;
            if (CalcMinFeed)
            {
                MinFeedString = Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0);
            }
        }
    }
    public double Feed => Util.GetDouble(FeedString);

    #endregion

    #region Минутная подача
    private string minFeedString = String.Empty;

    public string MinFeedString
    {
        get => minFeedString;
        set
        {
            minFeedString = value;
            if (!CalcMinFeed)
            {
                FeedString = Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3);
            }
        }
    }

    public double MinFeed => Util.GetDouble(MinFeedString);

    #endregion

    public string CalcInfo
    {
        get
        {
            string text = string.Empty;
            if (CalcSpins && Diameter > 0 && CutSpeed > 0)
            {
                text += $"Обороты: ({CutSpeed.ToPrettyString()}*1000)/(π*{Diameter}) = {Util.ToPrettyString((CutSpeed * 1000) / (Diameter * Math.PI), 0)} об/мин";
            }
            if (!CalcSpins && Diameter > 0 && SpindleSpeed > 0)
            {
                text += $"Скорость: π*{Diameter}*{SpindleSpeed}/1000 = {Util.ToPrettyString((Diameter * Math.PI * SpindleSpeed) / 1000, 0)} м/мин";
            }
            if (CalcMinFeed && Diameter > 0 && SpindleSpeed > 0 && Feed > 0)
            {
                text += Edges == 1
                    ? $"\nПодачу: {Feed.ToPrettyString()}*{SpindleSpeed} = {Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0)} мм/мин"
                    : $"\nПодачу: {Feed.ToPrettyString()}*{SpindleSpeed}*{Edges} = {Util.ToPrettyString(Feed * SpindleSpeed * Edges, 0)} мм/мин";
            }
            if (!CalcMinFeed && Diameter > 0 && SpindleSpeed > 0 && MinFeed > 0)
            {
                text += Edges == 1
                    ? $"\nПодачу: {MinFeed}/{SpindleSpeed} = {Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3)} {FeedUnits}"
                    : $"\nПодачу: {MinFeed}/{SpindleSpeed}*{Edges} = {Util.ToPrettyString(MinFeed / (SpindleSpeed * Edges), 3)} {FeedUnits}";
            }
            return text;
        }
        set { }
    }

    public string Answer { get; set; } = "";
    public string UserExpression { get; set; } = "";

    async Task AddToExpr(string text)
    {
        if (activeField == null) return;

        try
        {
            var inputRef = activeField.InputReference;
            if (inputRef == null) return;

            // Получаем текущее значение
            var currentValue = activeField.Value ?? string.Empty;

            // Используем JS interop для получения позиции курсора
            var selectionStart = await JSRuntime.InvokeAsync<int>("eval",
                $"document.getElementById('{GetInputId(activeField)}').selectionStart");
            var selectionEnd = await JSRuntime.InvokeAsync<int>("eval",
                $"document.getElementById('{GetInputId(activeField)}').selectionEnd");

            // Вставляем текст в позицию курсора
            var newValue = currentValue.Substring(0, selectionStart) + text + currentValue.Substring(selectionEnd);

            // Обновляем значение соответствующего поля
            UpdateFieldValue(activeField, newValue);

            StateHasChanged();

            // Устанавливаем курсор после вставленного текста
            await Task.Delay(10);
            var newCursorPos = selectionStart + text.Length;
            await inputRef.SelectRangeAsync(newCursorPos, newCursorPos);
        }
        catch (Exception ex)
        {
            // Fallback - добавляем в конец
            Console.WriteLine($"Ошибка при вставке: {ex.Message}");
            FallbackAddToExpr(text);
        }
    }

    async Task EraseLeftExpr()
    {
        if (activeField == null) return;

        try
        {
            var inputRef = activeField.InputReference;
            if (inputRef == null) return;

            var currentValue = activeField.Value ?? string.Empty;

            if (currentValue.Length == 0) return;

            var selectionStart = await JSRuntime.InvokeAsync<int>("eval",
                $"document.getElementById('{GetInputId(activeField)}').selectionStart");
            var selectionEnd = await JSRuntime.InvokeAsync<int>("eval",
                $"document.getElementById('{GetInputId(activeField)}').selectionEnd");

            string newValue;
            int newCursorPos;

            if (selectionStart != selectionEnd)
            {
                newValue = currentValue.Substring(0, selectionStart) + currentValue.Substring(selectionEnd);
                newCursorPos = selectionStart;
            }
            else if (selectionStart > 0)
            {
                newValue = currentValue.Substring(0, selectionStart - 1) + currentValue.Substring(selectionStart);
                newCursorPos = selectionStart - 1;
            }
            else
            {
                return;
            }

            UpdateFieldValue(activeField, newValue);

            StateHasChanged();

            await Task.Delay(10);
            await inputRef.SelectRangeAsync(newCursorPos, newCursorPos);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при удалении: {ex.Message}");
            FallbackEraseLeftExpr();
        }
    }

    void ClearCalculator()
    {
        if (activeField != null && activeField != exprField)
        {
            UpdateFieldValue(activeField, string.Empty);
        }
        else
        {
            UserExpression = string.Empty;
            Answer = string.Empty;
        }
    }

    private string GetInputId(MudTextField<string> field)
    {
        if (field == diameterField) return "calculator-diameter";
        if (field == edgesField) return "calculator-edges";
        if (field == cutSpeedField) return "calculator-cutSpeed";
        if (field == feedField) return "calculator-feed";
        if (field == spindleSpeedField) return "calculator-spindleSpeed";
        if (field == minFeedField) return "calculator-minFeed";
        if (field == exprField) return "calculator-expression";
        return "calculator-field";
    }

    private void UpdateFieldValue(MudTextField<string> field, string value)
    {
        if (field == diameterField) DiameterString = value;
        else if (field == edgesField) EdgesString = value;
        else if (field == cutSpeedField) CutSpeedString = value;
        else if (field == feedField) FeedString = value;
        else if (field == spindleSpeedField) SpindleSpeedString = value;
        else if (field == minFeedField) MinFeedString = value;
        else if (field == exprField) UserExpression = value;
    }

    private void FallbackAddToExpr(string text)
    {
        if (activeField == exprField)
        {
            UserExpression += text;
        }
        else if (activeField != null)
        {
            var currentValue = activeField.Value ?? string.Empty;
            UpdateFieldValue(activeField, currentValue + text);
        }
    }

    private void FallbackEraseLeftExpr()
    {
        if (activeField == exprField && UserExpression.Length > 0)
        {
            UserExpression = UserExpression[..^1];
        }
        else if (activeField != null)
        {
            var currentValue = activeField.Value ?? string.Empty;
            if (currentValue.Length > 0)
            {
                UpdateFieldValue(activeField, currentValue[..^1]);
            }
        }
    }

    private void UpdateCursorPositionOnFocus(MudTextField<string>? field)
    {
        activeField = field;
    }


    void CalculateTrigonometricFunction(TrigonometricFunction function)
    {
        if (!double.TryParse(UserExpression
            .TrimStart("Sin(")
            .TrimStart("Cos(")
            .TrimStart("Tan(")
            .TrimStart("Atan(")
            .TrimEnd(')')
            .Replace(".", ","), out var userExpr))
        {
            UserExpression = "";
            Answer = "";
            return;
        }
        switch (function)
        {
            case TrigonometricFunction.Sin:
                UserExpression = $"Sin({userExpr})".Replace(',', '.');
                Answer = Math.Sin(userExpr.Radians()).ToString("0.####").Replace(',', '.');
                break;
            case TrigonometricFunction.Cos:
                UserExpression = $"Cos({userExpr})".Replace(',', '.');
                Answer = Math.Cos(userExpr.Radians()).ToString("0.####").Replace(',', '.');
                break;
            case TrigonometricFunction.Tan:
                UserExpression = $"Tan({userExpr})".Replace(',', '.');
                Answer = Math.Tan(userExpr.Radians()).ToString("0.####").Replace(',', '.');
                break;
            case TrigonometricFunction.Atan:
                UserExpression = $"Atan({userExpr})".Replace(',', '.');
                Answer = Math.Atan(userExpr).Degrees().ToString("0.####").Replace(',', '.');
                break;
            default:
                break;
        }
    }

    void Calculate()
    {
        List<string> calcErrors = new();
        try
        {
            var userExpr = UserExpression.Replace("𝜋", Math.PI.ToString()).Replace("²", "**2").Replace("^", "**").Replace(',', '.');
            var expr = new Expression(userExpr, ExpressionOptions.IgnoreCaseAtBuiltInFunctions | ExpressionOptions.CaseInsensitiveStringComparer);
            expr.Functions[DegreeToRadianFunction] = (args) =>
                {
                    if (args.Count() > 1) Util.ThrowLogged<ArgumentOutOfRangeException>($"Слишком много аргументов для функции {DegreeToRadianFunction}", calcErrors);
                    double d = args[0].Evaluate() switch
                    {
                        double dd => dd,
                        int ii => ii,
                        long ll => ll,
                        string ss => Util.ToDouble(ss.Replace(',', '.')),
                        _ => throw new ArgumentException($"Неподдерживаемый тип: {args?.GetType()}")
                    };
                    return d * Math.PI / 180;
                };

            expr.Functions[RadianToDegreeFunction] = (args) =>
            {
                if (args.Count() > 1) Util.ThrowLogged<ArgumentOutOfRangeException>($"Слишком много аргументов для функции {RadianToDegreeFunction}", calcErrors);
                double d = args[0].Evaluate() switch
                {
                    double dd => dd,
                    int ii => ii,
                    long ll => ll,
                    string ss => Util.ToDouble(ss.Replace(',', '.')),
                    _ => Util.ThrowLogged<ArgumentException>($"Неподдерживаемый тип: {args?.GetType()}", calcErrors),
                };
                return d * 180 / Math.PI;
            };
            if (expr.HasErrors())
            {
                Snackbar.Add(expr.Error.Message);
                return;
            }
            var r = expr.Evaluate();
            if (r is null)
            {
                Snackbar.Add("Не удалось вычислить");
                return;
            }
            var result = r is double d ? d.ToString("0.####").Replace(',', '.') :
                         r is int i ? i.ToString() :
                         r is long l ? l.ToString() :
                         r?.ToString() ?? "[?]";
            UserExpression = result;
            Answer = result;
            activeField = exprField;
            StateHasChanged();
            _ = SetCursorToEnd();
            return;
        }
        catch
        {
            Snackbar.Add($"Ошибки при вычислении: {string.Join(", ", calcErrors)}");
        }
    }

    private async Task SetCursorToEnd()
    {
        if (exprField?.InputReference != null)
        {
            await Task.Delay(50);

            try
            {
                await exprField.InputReference.FocusAsync();
                var length = UserExpression?.Length ?? 0;
                await exprField.InputReference.SelectRangeAsync(length, length);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка при установке курсора: {ex.Message}");
            }
        }
    }
}