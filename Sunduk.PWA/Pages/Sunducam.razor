@page "/sunducam"
@inject IDialogService DialogService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@using MudBlazor.Services
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-3">
    <MudAlert Class="rounded-0" Severity="Severity.Warning" Icon="fas fa-crutch">Раздел в разработке</MudAlert>
    <MudGrid Spacing=1>
        <MudItem xs="12">
            <MudExpansionPanel HideIcon="true">
                <TitleContent>
                    <div class="d-flex">
                        <MudButtonGroup Variant="Variant.Outlined" OverrideStyles=false>
                            <MudIconButton Icon="@Icons.Material.TwoTone.Save" Title="Скачать программу" Variant=Variant.Outlined
                                           OnClick="DownloadProgram" />
                            <MudIconButton Icon="@Icons.Material.TwoTone.TableView" Title="Инструмент" OnClick="OpenToolDialog" Variant=Variant.Outlined
                                           Color="(Mode == Mode.ToolTable ? Color.Primary : Color.Default)" Class="ml-1" />
                            <MudHidden Breakpoint=Breakpoint.Xs>
                                <MudButton OnClick="OpenSequencelDialog" EndIcon="@Icons.Material.Outlined.PlaylistAdd" Disabled="@(!ValidWorkpiece)" Variant=Variant.Outlined
                                           Color="(Mode == Mode.AddSequence ? Color.Primary : Color.Default)" Class="ml-1">Добавить переход</MudButton>
                            </MudHidden>
                            <MudHidden Breakpoint=Breakpoint.Xs Invert=true>
                                <MudIconButton OnClick="OpenSequencelDialog" Icon="@Icons.Material.Outlined.PlaylistAdd" Disabled="@(!ValidWorkpiece)" Variant=Variant.Outlined
                                               Color="(Mode == Mode.AddSequence ? Color.Primary : Color.Default)" Class="ml-1">Добавить переход</MudIconButton>
                            </MudHidden>
                        </MudButtonGroup>
                        <MudIcon Icon="@Icons.Material.TwoTone.Settings" Class="d-flex ml-auto mt-1" />
                    </div>
                </TitleContent>
                <ChildContent>
                    <MudGrid Spacing="1">
                        <MudItem xs="12" sm="7" md="8">
                            <MudSelect @bind-Value="Machine" Label="Станок" T="Machine" Variant="Variant.Filled" Dense="true">
                                <MudSelectItem Value="@(Machine.L230A)">Hyundai L230A</MudSelectItem>
                                <MudSelectItem Value="@(Machine.GS1500)">Goodway GS-1500</MudSelectItem>
                                <MudSelectItem Value="@(Machine.A110)">Victor A110</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="5" md="4">
                            @*<MudTextField @bind-Value="WorkpieceLength" Label="Длина заготовки" Adornment="Adornment.End" AdornmentText="мм" Variant="Variant.Text" Immediate="true" Margin="Margin.Dense" />*@
                            <MudSelect @bind-Value="WorkpieceMaterial" Label="Материал детали" T="Material" Variant="Variant.Filled" Dense="true">
                                <MudSelectItem Value="@Material.Steel">Черная сталь</MudSelectItem>
                                <MudSelectItem Value="@Material.Stainless">Нержавеющая сталь</MudSelectItem>
                                <MudSelectItem Value="@Material.Brass">Бронза</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="6">
                            <MudTextField @bind-Value="DetailName" Label="Наименование" Variant="Variant.Filled" Immediate="true" Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="12" sm="6" md="6">
                            <MudTextField @bind-Value="DetailNumber" Label="Обозначение" Variant="Variant.Filled" Immediate="true" Margin="Margin.Dense" />
                        </MudItem>
                        @if (MachineType == MachineType.Turning)
                        {
                            <MudItem xs="12" sm="4">
                                <MudTextField @bind-Value="_WorkpieceExternalDiameter" Label="Наружный диаметр" Adornment="Adornment.End" AdornmentText="мм" Variant="Variant.Filled" Immediate="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudTextField @bind-Value="_WorkpieceInternalDiameter" Label="Внутренний диаметр" Adornment="Adornment.End" AdornmentText="мм" Variant="Variant.Filled" Immediate="true" Margin="Margin.Dense" />
                            </MudItem>
                            <MudItem xs="12" sm="4">
                                <MudTextField @bind-Value="SpindleLimit" Label="Ограничение оборотов" Variant="Variant.Filled" Immediate="true" Margin="Margin.Dense" />
                            </MudItem>
                        }
                        <MudItem xs="12" sm="4">
                            <MudNumericField @bind-Value="OperationNumber" Label="Номер установа" Variant="Variant.Filled" Immediate="true" Format="D1" Min="0" Max="10" Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="DrawningVersion" Label="Версия чертежа" Variant="Variant.Filled" Immediate="true" Converter="Util.DoubleConverter" Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField @bind-Value="Author" Label="Автор" Variant="Variant.Filled" Immediate="true" Margin="Margin.Dense" />
                        </MudItem>
                    </MudGrid>
                </ChildContent>
            </MudExpansionPanel>
        </MudItem>
        @switch (Mode)
        {
            case Mode.General:
                <MudItem xs="12" sm="6">
                    <MudField Label="Список переходов" Variant="Variant.Filled" Margin="Margin.Dense" @onfocusout="DropSelection">
                        <MudList Clickable="true" @bind-SelectedItem="SelectedSequence" @bind-SelectedValue="SelectedSequenceIndex" Dense="true" DisableGutters=true>
                            @if (Program != null)
                            {
                                foreach (var seq in Program)
                                {
                                    if (Program.IndexOf(seq) == 0)
                                    {
                                        <MudListItem Text="@($"1. {seq.Name}")" Value="1">
                                            <MudGrid>
                                                <MudText Class="ma-3" Typo=Typo.body2>@($"1. {seq.Name}")</MudText>
                                            </MudGrid>
                                        </MudListItem>
                                    }
                                    if (Program.IndexOf(seq) > 1)
                                    {
                                        <MudListItem Text="@($"{Program.IndexOf(seq)}. {seq.Name}")" Value="Program.IndexOf(seq)">
                                            <MudGrid>
                                                @if (seq.MachineType != MachineType.Any && seq.MachineType != MachineType)
                                                {
                                                    <MudTooltip Placement="Placement.Right" Text="Этот переход будет игнорирован, т.к. его тип не совпадает с типом станка.">
                                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" 
                                                                 Style="margin-top: 10px; margin-bottom: 0px; margin-left: 16px"/>
                                                    </MudTooltip>

                                                }
                                                <MudText Class="ma-3 mr-auto" Typo=Typo.body2>@($"{Program.IndexOf(seq)}. {seq.Name}")</MudText>
                                                <div Class="d-inline-flex justify-end py-2 px-3">
                                                    @if (SelectedSequenceIndex != null && (int)SelectedSequenceIndex == Program.IndexOf(seq))
                                                    {
                                                        <MudButtonGroup Variant="Variant.Outlined" OverrideStyles="false" Class="mr-2" Style="margin-top: -3px; margin-bottom: -3px">
                                                            @if (Program.IndexOf(seq) != Program.Count - 1)
                                                                {
                                                                    <MudIconButton Icon="@Icons.Material.TwoTone.KeyboardArrowDown" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                                                                   OnClick="(() => MoveDownSequence(seq))" />
                                                                }
                                                                @if (Program.IndexOf(seq) != 2)
                                                                {
                                                                    <MudIconButton Icon="@Icons.Material.TwoTone.KeyboardArrowUp" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                                                                   OnClick="(() => MoveUpSequence(seq))" />
                                                                }
                                                            @if (seq.MachineType == MachineType)
                                                            {
                                                                
                                                                <MudIconButton Icon="@Icons.Material.TwoTone.Edit" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                                                               OnClick="(() => OpenEditSequenceDialog(seq))" />
                                                            }
                                                            <MudIconButton Icon="@Icons.Material.TwoTone.Delete" Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                                                                           OnClick="(() => Program.Remove(seq))" />
                                                        </MudButtonGroup>
                                                    }
                                                </div>
                                            </MudGrid>
                                        </MudListItem>
                                    }
                                }
                            }
                        </MudList>
                    </MudField>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudField Label="Программа" Variant="Variant.Filled" Margin="Margin.Dense">
                        <MudTextField T="string" DisableUnderLine="true" 
                                      Style="font-family: 'Roboto Mono', monospace; font-size: medium;" 
                                      Variant="Variant.Text" @bind-Text="@ProgramText" 
                                      ReadOnly="true" Immediate="true" Lines="@(ProgramText.Count(x => x == '\n') + 2)" />
                    </MudField>
                    @*<MudField Label="Программа" Variant="Variant.Filled" Margin="Margin.Dense">
                            @foreach (var programLine in programList)
                            {
                                <MudText Style="font-family: 'Roboto Mono', monospace; font-size: medium;">
                                    <MudHighlighter Text="@programLine" 
                                        Class="mud-primary-text"
                                        Style="background-color:transparent;"
                                        HighlightedText="@HighLight"
                                        UntilNextBoundary="false"
                                        CaseSensitive="true" />
                                </MudText>
                            }
                    </MudField>*@
                </MudItem>
                break;
            case Mode.ToolTable:
                <MudItem xs=12>
                    <ToolTableComponent Tools="Tools" 
                                        MachineType="MachineType" />
                </MudItem>
                break;
            case Mode.AddSequence:
                <MudItem xs=12>
                    <MudPaper Class="pa-4 rounded-0" Elevation="0" Outlined="false">
                        <AddSequenceComponent Tools="Tools"
                                          Machine="Machine"
                                          MachineType="MachineType"
                                          Program="Program"
                                          @bind-Mode="Mode"
                                          WorkpieceMaterial="WorkpieceMaterial"
                                          WorkpieceExternalDiameter="WorkpieceExternalDiameter"
                                          WorkpieceInternalDiameter="WorkpieceInternalDiameter"
                                          WorkpieceCurrentInternalDiameter="WorkpieceCurrentInternalDiameter"
                                          WorkpieceLength="WorkpieceLength"
                                          CyclesCount="CyclesCount" />
                    </MudPaper>
                </MudItem>
                break;
        }
    </MudGrid>
</MudContainer>

@code
{
    [Inject] public IBlazorDownloadFileService BlazorDownloadFileService { get; set; }

    [Inject] IBreakpointService BreakpointListener { get; set; }


    public Mode Mode { get; set; } = Mode.General;

    public string HighLight => SelectedSequence is null ? string.Empty : Program[(int)SelectedSequenceIndex].Operation.Split('\n')[0];

    public MudListItem SelectedSequence;
    public object SelectedSequenceIndex = 0;

    public int CyclesCount
    {
        get
        {
            return Program.Where(x =>
            x is RoughFacingSequence ||
            x is FacingSequence ||
            x is RoughFacingCycleSequence)
                .Count() + 1;
        }
        set { }
    }

    public List<Tool> Tools { get; set; } = new();

    #region Фрезерный инструмент
    public List<MillingTool> MillingTools { get; set; }
    public List<MillingDrillingTool> MillingDrillingTools { get; set; }
    public List<MillingTappingTool> MillingTappingTools { get; set; }
    #endregion

    #region Токарныый инструмент
    public List<GroovingExternalTool> GroovingExternalTools { get; set; }
    public List<GroovingInternalTool> GroovingInternalTools { get; set; }
    public List<SpecialTurningTool> SpecialTurningTools { get; set; }
    public List<ThreadingExternalTool> ThreadingExternalTools { get; set; }
    public List<ThreadingInternalTool> ThreadingInternalTools { get; set; }
    public List<TurningDrillingTool> TurningDrillingTools { get; set; }
    public List<TurningExternalTool> TurningExternalTools { get; set; }
    public List<TurningInternalTool> TurningInternalTools { get; set; }
    public List<TurningTappingTool> TurningTappingTools { get; set; }
    #endregion


    public Material WorkpieceMaterial { get; set; }
    public Machine Machine { get; set; }
    public MachineType MachineType { get => Machine.GetMachineType(); }

    public string _WorkpieceExternalDiameter { get; set; } = "50";
    public double WorkpieceExternalDiameter { get => Util.GetDouble(_WorkpieceExternalDiameter); }

    public string _WorkpieceInternalDiameter { get; set; } = string.Empty;
    public double WorkpieceInternalDiameter { get => Util.GetDouble(_WorkpieceInternalDiameter); }

    public double WorkpieceCurrentExternalDiameter { get; set; }
    public double WorkpieceCurrentInternalDiameter { get => GetCurrentInternalDiameter(Program.Count); }

    private double GetCurrentInternalDiameter(int index)
    {
        double diam = WorkpieceInternalDiameter;
        for (int i = 0; i < index; i++)
        {
            switch (Program[i])
            {
                case HighSpeedDrillingSequence highSpeedDrillingSequence:
                    if (highSpeedDrillingSequence.Tool.Diameter > diam) diam = highSpeedDrillingSequence.Tool.Diameter;
                    break;
                case PeckDrillingSequence peckDrillingSequence:
                    if (peckDrillingSequence.Tool.Diameter > diam) diam = peckDrillingSequence.Tool.Diameter;
                    break;
                case PeckDeepDrillingSequence peckDeepDrillingSequence:
                    if (peckDeepDrillingSequence.Tool.Diameter > diam) diam = peckDeepDrillingSequence.Tool.Diameter;
                    break;
                default:
                    break;
            }
        }
        return diam;
    }

    public string DetailNumber { get; set; }

    public string NcDetailNumber { get => $"{(!string.IsNullOrEmpty(DetailNumber) ? DetailNumber.Translate() : "AR000-00-000")}.{ OperationNumber.ToString("D1").Replace(",", ".")}S"; }

    public string DetailName { get; set; }
    public string NcDetailName { get => !string.IsNullOrEmpty(DetailName) ? $"{DetailName.Translate()}" : "DETAIL"; }

    public string Author { get; set; }
    public string NcAuthor { get => !string.IsNullOrEmpty(Author) ? $"{Author.Translate()}" : "AUTHOR"; }

    public int OperationNumber { get; set; } = 1;

    public double DrawningVersion { get; set; }

    public int? SpindleLimit { get; set; }

    public string _WorkpieceLength { get; set; } = "50";
    public double WorkpieceLength { get => Util.GetDouble(_WorkpieceLength); }


    //public Sequence Header => new Sequence { Name = "Шапка", Operation = Operation.Header(Machine, NcDetailNumber, NcDetailName, DrawningVersion) };
    //public string Header => Operation.Header(Machine, NcDetailNumber, NcDetailName, DrawningVersion);
    //public Sequence SafetyString => new Sequence { Name = "Строка безопасности", Operation = Operation.SafetyString(Machine, 3000) };
    //public string SafetyString => Operation.SafetyString(Machine, 3000);

    public bool ValidWorkpiece
    {
        get
        {
            if (WorkpieceExternalDiameter > 0 && WorkpieceInternalDiameter < WorkpieceExternalDiameter && WorkpieceLength > 0)
            {
                return true;
            }
            return false;
        }
    }

    public List<Sequence> Program { get; set; }

    public string ProgramEnd { get
        {
            return MachineType switch
            {
                MachineType.Turning => "\nM30\n%",
                MachineType.Milling => "\nM30\n%",
                _ => string.Empty
            };
        } }

    protected override async Task OnInitializedAsync()
    {
        // MillingDrilling
        MillingDrillingTools = await localStorage.GetItemAsync<List<MillingDrillingTool>>(nameof(MillingDrillingTools)) ?? new();
        if (MillingDrillingTools is null || MillingDrillingTools.Count == 0)
        {
            MillingDrillingTools.Add(new MillingDrillingTool(1, MillingDrillingTool.Types.Solid, 6, 140));
            MillingDrillingTools.Add(new MillingDrillingTool(2, MillingDrillingTool.Types.Insert, 25, 180));
            await localStorage.SetItemAsync(nameof(MillingDrillingTools), MillingDrillingTools);
        }
        Tools.AddRange(MillingDrillingTools);

        // MillingTapping
        MillingTappingTools = await localStorage.GetItemAsync<List<MillingTappingTool>>(nameof(MillingTappingTools)) ?? new();
        if (MillingTappingTools is null || MillingTappingTools.Count == 0)
        {
            MillingTappingTools.Add(new MillingTappingTool(3, MillingTappingTool.Types.Cutting, 12, 1.75));
            MillingTappingTools.Add(new MillingTappingTool(4, MillingTappingTool.Types.Forming, 10, 1.5));
            await localStorage.SetItemAsync(nameof(MillingTappingTools), MillingTappingTools);
        }
        Tools.AddRange(MillingTappingTools);

        // Milling
        MillingTools = await localStorage.GetItemAsync<List<MillingTool>>(nameof(MillingTools)) ?? new();
        if (MillingTools is null || MillingTools.Count == 0)
        {
            MillingTools.Add(new MillingTool(3, MillingTool.Types.Solid, 12));
            MillingTools.Add(new MillingTool(4, MillingTool.Types.Insert, 32));
            await localStorage.SetItemAsync(nameof(MillingTools), MillingTools);
        }
        Tools.AddRange(MillingTools);

        // GroovingExternal
        GroovingExternalTools = await localStorage.GetItemAsync<List<GroovingExternalTool>>(nameof(GroovingExternalTools)) ?? new();
        if (GroovingExternalTools is null || GroovingExternalTools.Count == 0)
        {
            GroovingExternalTools.Add(new GroovingExternalTool(1212, GroovingExternalTool.Types.Grooving, 3, GroovingExternalTool.Point.Left));
            GroovingExternalTools.Add(new GroovingExternalTool(1212, GroovingExternalTool.Types.Cutting, 3, GroovingExternalTool.Point.Right));
            await localStorage.SetItemAsync(nameof(GroovingExternalTools), GroovingExternalTools);
        }
        Tools.AddRange(GroovingExternalTools);

        // GroovingInternal
        GroovingInternalTools = await localStorage.GetItemAsync<List<GroovingInternalTool>>(nameof(GroovingInternalTools)) ?? new();
        if (GroovingInternalTools is null || GroovingInternalTools.Count == 0)
        {
            GroovingInternalTools.Add(new GroovingInternalTool(1212, 20, 3, GroovingInternalTool.Point.Right));
            GroovingInternalTools.Add(new GroovingInternalTool(1212, 40, 4, GroovingInternalTool.Point.Right));
            await localStorage.SetItemAsync(nameof(GroovingInternalTools), GroovingInternalTools);
        }
        Tools.AddRange(GroovingInternalTools);

        // SpecialTurning
        SpecialTurningTools = await localStorage.GetItemAsync<List<SpecialTurningTool>>(nameof(SpecialTurningTools)) ?? new();
        if (SpecialTurningTools is null || SpecialTurningTools.Count == 0)
        {
            SpecialTurningTools.Add(new SpecialTurningTool(0101, "UPOR"));
            await localStorage.SetItemAsync(nameof(SpecialTurningTools), SpecialTurningTools);
        }
        Tools.AddRange(SpecialTurningTools);

        // ThreadingExternal
        ThreadingExternalTools = await localStorage.GetItemAsync<List<ThreadingExternalTool>>(nameof(ThreadingExternalTools)) ?? new();
        if (ThreadingExternalTools is null || ThreadingExternalTools.Count == 0)
        {
            ThreadingExternalTools.Add(new ThreadingExternalTool(1111, 1.5, 1));
            await localStorage.SetItemAsync(nameof(ThreadingExternalTools), ThreadingExternalTools);
        }
        Tools.AddRange(ThreadingExternalTools);

        // ThreadingInternal
        ThreadingInternalTools = await localStorage.GetItemAsync<List<ThreadingInternalTool>>(nameof(ThreadingInternalTools)) ?? new();
        if (ThreadingInternalTools is null || ThreadingInternalTools.Count == 0)
        {
            ThreadingInternalTools.Add(new ThreadingInternalTool(1111, 16, 1.5, 1));
            await localStorage.SetItemAsync(nameof(ThreadingInternalTools), ThreadingInternalTools);
        }
        Tools.AddRange(ThreadingInternalTools);

        // TurningDrilling
        TurningDrillingTools = await localStorage.GetItemAsync<List<TurningDrillingTool>>(nameof(TurningDrillingTools)) ?? new();
        if (TurningDrillingTools is null || TurningDrillingTools.Count == 0)
        {
            TurningDrillingTools.Add(new TurningDrillingTool(0505, TurningDrillingTool.Types.Rapid, 5, 120));
            TurningDrillingTools.Add(new TurningDrillingTool(0707, TurningDrillingTool.Types.Solid, 10, 140));
            TurningDrillingTools.Add(new TurningDrillingTool(0606, TurningDrillingTool.Types.Insert, 25, 180));
            await localStorage.SetItemAsync(nameof(TurningDrillingTools), TurningDrillingTools);
        }
        Tools.AddRange(TurningDrillingTools);

        // TurningExternal
        TurningExternalTools = await localStorage.GetItemAsync<List<TurningExternalTool>>(nameof(TurningExternalTools)) ?? new();
        if (TurningExternalTools is null || TurningExternalTools.Count == 0)
        {
            TurningExternalTools.Add(new TurningExternalTool(0202, TurningExternalTool.Types.Bar, 55, 0.8));
            TurningExternalTools.Add(new TurningExternalTool(0202, TurningExternalTool.Types.Face, 100, 0.8));
            TurningExternalTools.Add(new TurningExternalTool(0303, TurningExternalTool.Types.Bar, 35, 0.4));
            await localStorage.SetItemAsync(nameof(TurningExternalTools), TurningExternalTools);
        }
        Tools.AddRange(TurningExternalTools);

        // TurningInternal
        TurningInternalTools = await localStorage.GetItemAsync<List<TurningInternalTool>>(nameof(TurningInternalTools)) ?? new();
        if (TurningInternalTools is null || TurningInternalTools.Count == 0)
        {
            TurningInternalTools.Add(new TurningInternalTool(0202, 25, 55, 0.8));
            TurningInternalTools.Add(new TurningInternalTool(0202, 32, 80, 0.8));
            TurningInternalTools.Add(new TurningInternalTool(0303, 10, 55, 0.4));
            await localStorage.SetItemAsync(nameof(TurningInternalTools), TurningInternalTools);
        }
        Tools.AddRange(TurningInternalTools);

        // TurningTapping
        TurningTappingTools = await localStorage.GetItemAsync<List<TurningTappingTool>>(nameof(TurningTappingTools)) ?? new();
        if (TurningTappingTools is null || TurningTappingTools.Count == 0)
        {
            TurningTappingTools.Add(new TurningTappingTool(0909, TurningTappingTool.Types.Cutting, 12, 1.75));
            TurningTappingTools.Add(new TurningTappingTool(0808, TurningTappingTool.Types.Forming, 10, 1.5));
            await localStorage.SetItemAsync(nameof(TurningTappingTools), TurningTappingTools);
        }
        Tools.AddRange(TurningTappingTools);


        Program = new();
        Program.Add(new HeaderSequence(Machine, DetailNumber, DetailName, Author, DrawningVersion, string.Empty) { Name = $"Шапка" });
        Program.Add(new SafetyStringSequence(Machine, 3000) { Name = $"Строка безопасности" });
        CyclesCount = 1;
    }

    private async Task SaveTools()
    {

        await localStorage.SetItemAsync(nameof(MillingDrillingTools), MillingDrillingTools);
        await localStorage.SetItemAsync(nameof(MillingTappingTools), MillingTappingTools);
        await localStorage.SetItemAsync(nameof(MillingTools), MillingTools);
        await localStorage.SetItemAsync(nameof(GroovingExternalTools), GroovingExternalTools);
        await localStorage.SetItemAsync(nameof(GroovingInternalTools), GroovingInternalTools);
        await localStorage.SetItemAsync(nameof(SpecialTurningTools), SpecialTurningTools);
        await localStorage.SetItemAsync(nameof(ThreadingExternalTools), ThreadingExternalTools);
        await localStorage.SetItemAsync(nameof(ThreadingInternalTools), ThreadingInternalTools);
        await localStorage.SetItemAsync(nameof(TurningDrillingTools), TurningDrillingTools);
        await localStorage.SetItemAsync(nameof(TurningExternalTools), TurningExternalTools);
        await localStorage.SetItemAsync(nameof(TurningInternalTools), TurningInternalTools);
        await localStorage.SetItemAsync(nameof(TurningTappingTools), TurningTappingTools);

    }

    private async Task OpenToolDialog()
    {
        await Task.Run(SaveTools);
        if (Mode != Mode.ToolTable)
        {
            Mode = Mode.ToolTable;
        }
        else
        {
            Mode = Mode.General;
        }
    }

    private async Task OpenEditSequenceDialog(Sequence sequence)
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(Tools), Tools);
        parameters.Add(nameof(Program), Program);
        parameters.Add(nameof(sequence), sequence);
        var options = new DialogOptions() { FullScreen = false, CloseButton = false };
        var dialog = DialogService.Show<EditSequenceDialog>("Редактировать переход", parameters, options);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            Program = Program;
        }
    }


    private async Task OpenSequencelDialog()
    {
        await Task.Run(SaveTools);
        if (Mode != Mode.AddSequence)
        {
            Mode = Mode.AddSequence;
        }
        else
        {
            Mode = Mode.General;
        }
    }

    private async Task<bool> OpenConfirmDialog(string message)
    {
        if (message is null) message = string.Empty;
        var parameters = new DialogParameters();
        parameters.Add(nameof(message), message);
        var options = new DialogOptions() { FullScreen = false, CloseButton = false };
        var dialog = DialogService.Show<ConfirmDialog>("Подтверждение", parameters, options);
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            return true;
        }
        return false;
    }

    private void RemoveSequence(Sequence seq)
    {
        Program.Remove(seq);
    }

    private void MoveUpSequence(Sequence seq)
    {
        int index = Program.IndexOf(seq) - 1;
        Program.Swap(Program.IndexOf(seq), Program.IndexOf(seq) - 1);
        SelectedSequenceIndex = (object)index;
    }

    private void MoveDownSequence(Sequence seq)
    {
        int index = Program.IndexOf(seq) + 1;
        Program.Swap(Program.IndexOf(seq), Program.IndexOf(seq) + 1);
        SelectedSequenceIndex = (object)index;
    }

    private void DropSelection()
    {
        SelectedSequence = null;
        SelectedSequenceIndex = null;
    }

    private async Task DownloadProgram()
    {
        bool resultDialog = await OpenConfirmDialog($"Скачать файл \"{NcDetailNumber}.nc\" ?");
        if (resultDialog) await BlazorDownloadFileService.DownloadFileFromText(NcDetailNumber + ".nc", ProgramText, System.Text.Encoding.UTF8, "text/plain");
    }

    public string ProgramText
    {
        get
        {
            if (Program is null) return string.Empty;

            List<string> result = new();

            for (int i = 0; i < Program.Count; i++)
            {
                switch (Program[i])
                {
                    case HeaderSequence headerSequence:
                        HeaderSequence newHeaderSequence = Program[i] as HeaderSequence;
                        newHeaderSequence.Machine = Machine;
                        newHeaderSequence.DetailNumber = NcDetailNumber;
                        newHeaderSequence.DetailName = NcDetailName;
                        newHeaderSequence.Author = NcAuthor;
                        newHeaderSequence.DrawVersion = DrawningVersion;
                        newHeaderSequence.ToolTable = Util.GetToolTable(Machine, Program);
                        Program[i] = newHeaderSequence;
                        break;
                    case SafetyStringSequence safetyStringSequence:
                        SafetyStringSequence newSafetyStringSequence = Program[i] as SafetyStringSequence;
                        newSafetyStringSequence.Machine = Machine;
                        newSafetyStringSequence.SpeedLimit = SpindleLimit;
                        Program[i] = newSafetyStringSequence;
                        break;
                    case LimiterSequence limiterSequence:
                        LimiterSequence newlimiterSequence = Program[i] as LimiterSequence;
                        newlimiterSequence.Machine = Machine;
                        Program[i] = newlimiterSequence;
                        break;
                    case FacingSequence facingSequence:
                        FacingSequence newFacingSequence = Program[i] as FacingSequence;
                        newFacingSequence.Machine = Machine;
                        newFacingSequence.Material = WorkpieceMaterial;
                        newFacingSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        newFacingSequence.InternalDiameter = GetCurrentInternalDiameter(i);
                        Program[i] = newFacingSequence;
                        break;
                    case RoughFacingSequence roughFacingSequence:
                        RoughFacingSequence newRoughFacingSequence = Program[i] as RoughFacingSequence;
                        newRoughFacingSequence.Machine = Machine;
                        newRoughFacingSequence.Material = WorkpieceMaterial;
                        newRoughFacingSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        newRoughFacingSequence.InternalDiameter = GetCurrentInternalDiameter(i);
                        Program[i] = newRoughFacingSequence;
                        break;
                    case RoughFacingCycleSequence roughFacingCycleSequence:
                        RoughFacingCycleSequence newRoughFacingCycleSequence = Program[i] as RoughFacingCycleSequence;
                        newRoughFacingCycleSequence.Machine = Machine;
                        newRoughFacingCycleSequence.Material = WorkpieceMaterial;
                        newRoughFacingCycleSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        newRoughFacingCycleSequence.InternalDiameter = GetCurrentInternalDiameter(i);
                        Program[i] = newRoughFacingCycleSequence;
                        break;
                    case FinishFacingSequence finishFacingSequence:
                        FinishFacingSequence newFinishFacingSequence = Program[i] as FinishFacingSequence;
                        newFinishFacingSequence.Machine = Machine;
                        newFinishFacingSequence.Material = WorkpieceMaterial;
                        newFinishFacingSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        newFinishFacingSequence.InternalDiameter = GetCurrentInternalDiameter(i);
                        Program[i] = newFinishFacingSequence;
                        break;
                    case FinishFacingCycleSequence finishFacingCycleSequence:
                        break;
                    case TurningHighSpeedDrillingSequence turningHighSpeedDrillingSequence:
                        TurningHighSpeedDrillingSequence newTurningHighSpeedDrillingSequence = Program[i] as TurningHighSpeedDrillingSequence;
                        newTurningHighSpeedDrillingSequence.Machine = Machine;
                        newTurningHighSpeedDrillingSequence.Material = WorkpieceMaterial;
                        break;
                    case MillingHighSpeedDrillingSequence millingHighSpeedDrillingSequence:
                        MillingHighSpeedDrillingSequence newMillingHighSpeedDrillingSequencee = Program[i] as MillingHighSpeedDrillingSequence;
                        newMillingHighSpeedDrillingSequencee.Machine = Machine;
                        newMillingHighSpeedDrillingSequencee.Material = WorkpieceMaterial;
                        break;
                    case TurningPeckDrillingSequence turningPeckDrillingSequence:
                        TurningPeckDrillingSequence newTurningPeckDrillingSequence = Program[i] as TurningPeckDrillingSequence;
                        newTurningPeckDrillingSequence.Machine = Machine;
                        newTurningPeckDrillingSequence.Material = WorkpieceMaterial;
                        break;
                    case MillingPeckDrillingSequence millingPeckDrillingSequence:
                        MillingPeckDrillingSequence newMillingPeckDrillingSequence = Program[i] as MillingPeckDrillingSequence;
                        newMillingPeckDrillingSequence.Machine = Machine;
                        newMillingPeckDrillingSequence.Material = WorkpieceMaterial;
                        break;
                    case TurningPeckDeepDrillingSequence turningPeckDeepDrillingSequence:
                        TurningPeckDeepDrillingSequence newTurningPeckDeepDrillingSequence = Program[i] as TurningPeckDeepDrillingSequence;
                        newTurningPeckDeepDrillingSequence.Machine = Machine;
                        newTurningPeckDeepDrillingSequence.Material = WorkpieceMaterial;
                        break;
                    case MillingPeckDeepDrillingSequence millingPeckDeepDrillingSequence:
                        MillingPeckDeepDrillingSequence newMillingPeckDeepDrillingSequence = Program[i] as MillingPeckDeepDrillingSequence;
                        newMillingPeckDeepDrillingSequence.Machine = Machine;
                        newMillingPeckDeepDrillingSequence.Material = WorkpieceMaterial;
                        break;
                    case TurningTappingSequence TurningTappingSequence:
                        TurningTappingSequence newTurningTappingSequence = Program[i] as TurningTappingSequence;
                        newTurningTappingSequence.Machine = Machine;
                        break;
                    // миллинг таппинг
                    case ThreadCuttingSequence threadCuttingSequence:
                        ThreadCuttingSequence newThreadCuttingSequence = Program[i] as ThreadCuttingSequence;
                        newThreadCuttingSequence.Machine = Machine;
                        break;
                    case ToolCallSequence toolCallSequence:
                        ToolCallSequence newToolCallSequence = Program[i] as ToolCallSequence;
                        newToolCallSequence.Machine = Machine;
                        break;
                    default:
                        break;
                }
            }

            foreach (var sequence in Program)
            {
                if (Program.IndexOf(sequence) == Program.Count - 1)
                {
                    result.Add(sequence.Operation.Replace("/", string.Empty).Replace("M1", string.Empty));
                }
                else
                {
                    result.Add(sequence.Operation);
                }
            }
            return string.Join("\n", result.Where(x => !string.IsNullOrEmpty(x))).Trim() + ProgramEnd;
        }
        set { }        
    }
    IEnumerable<string> programList => ProgramText.Split('\n').ToList();

    // Инструмент


    // создание переходов


}
