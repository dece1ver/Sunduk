@page "/nc"
@inject IDialogService DialogService
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<style>
    .monofield {
        font-family: Consolas;
        font-size: 8px;
    }
</style>
<style>
    .monoitem {
        font-family: Consolas;
        font-size: 8px;
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-3">
    <MudGrid>
        <MudItem xs="9">
            <MudSelect @bind-Value="Machine" Label="Станок" T="Machines" Variant="Variant.Outlined">
                <MudSelectItem Value="@(Machines.GS1500)">Goodway GS-1500</MudSelectItem>
                <MudSelectItem Value="@(Machines.L230A)">Hyundai L230A</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="3">
            <MudButton Size="Size.Large" Style="height: 56px; margin-top: 5px;" FullWidth="true" Variant="Variant.Outlined" Color="Color.Primary" OnClick="OpenSequencelDialog" Disabled="@(!ValidWorkpiece)">Создать переход</MudButton>
        </MudItem>
        <MudField Label="Заготовка" Variant="Variant.Outlined" Style="margin: 12px" Margin="Margin.Dense">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_WorkpieceExternalDiameter" Label="Наружный диаметр" Adornment="Adornment.End" AdornmentText="мм" Variant="Variant.Text" Immediate="true" Margin="Margin.Dense"/>
                    <MudTextField @bind-Value="_WorkpieceInternalDiameter" Label="Внутренний диаметр" Adornment="Adornment.End" AdornmentText="мм" Variant="Variant.Text" Immediate="true" Margin="Margin.Dense"/>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_WorkpieceLength" Label="Длина заготовки" Adornment="Adornment.End" AdornmentText="мм" Variant="Variant.Text" Immediate="true" Margin="Margin.Dense"/>
                    <MudSelect @bind-Value="WorkpieceMaterial" Label="Материал" T="Materials" Variant="Variant.Text" Margin="Margin.Dense">
                        <MudSelectItem Value="@Materials.Steel">Черная сталь</MudSelectItem>
                        <MudSelectItem Value="@Materials.Stainless">Нержавеющая сталь</MudSelectItem>
                        <MudSelectItem Value="@Materials.Brass">Бронза</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudField>
        <MudField Label="Деталь" Variant="Variant.Outlined" Style="margin: 12px" Margin="Margin.Dense">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="DetailName" Label="Наименование" Variant="Variant.Text" Immediate="true" Margin="Margin.Dense" />
                    <MudNumericField @bind-Value="OperationNumber" Label="Номер установа" Variant="Variant.Text" Immediate="true" Format="D1" Min="0" Max="10" Margin="Margin.Dense"/>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="DetailNumber" Label="Обозначение" Variant="Variant.Text" Immediate="true" Margin="Margin.Dense" />
                    <MudTextField @bind-Value="DrawningVersion" Label="Версия чертежа" Variant="Variant.Text" Immediate="true" Converter="Util.DoubleConverter" Margin="Margin.Dense" />
                </MudItem>
            </MudGrid>
        </MudField>
        <MudGrid>
            <MudItem xs="5" sm="4" md="2">
                <MudField Label="Список переходов" Variant="Variant.Filled" Margin="Margin.Dense" Style="margin: 12px">
                    <MudList Clickable="true" Dense="true">
                        @if (Program != null)
                        {
                            @foreach (var seq in Program)
                            {
                                <MudListItem Text="@seq.Name" />
                            }
                        }
                    </MudList>
                </MudField>
            </MudItem>
            <MudItem xs="7" sm="8" md="10">
                <MudField Label="Программа" Variant="Variant.Filled" Margin="Margin.Dense" Style="margin: 12px">
                    <MudTextField T="string" DisableUnderLine="true" Class="monofield" Variant="Variant.Text" @bind-Text="@ProgramText" ReadOnly="true" Immediate="true" Lines="@(ProgramText.Count(x => x == '\n') + 2)" />
                </MudField>
                @*<MudTextField T="string" DisableUnderLine="true" Label="Тест" Class="monofield" Variant="Variant.Text" @bind-Text="@Message" ReadOnly="true" Immediate="true" Lines="50" />*@
            </MudItem>
        </MudGrid>
    </MudGrid>
</MudContainer>



@code
{

    const string TOOL_TABLE = @"<TOOL TABLE>";

    public string Message { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {

        #region Инициализация спец инструмента
        SpecialTools = await localStorage.GetItemAsync<List<SpecialTool>>(nameof(SpecialTools));
        if (SpecialTools is null || SpecialTools.Count == 0)
        {
            SpecialTools = new();
            SpecialTools.Add(new SpecialTool(0101, "UPOR"));
            await localStorage.SetItemAsync(nameof(SpecialTools), SpecialTools);
        }
        Tools.AddRange(SpecialTools);
        #endregion

        #region Инициализация токарного инструмента
        TurningExternalTools = await localStorage.GetItemAsync<List<TurningExternalTool>>(nameof(TurningExternalTools));
        if (TurningExternalTools is null || TurningExternalTools.Count == 0)
        {
            TurningExternalTools = new();
            TurningExternalTools.Add(new TurningExternalTool(0202, TurningExternalTool.Types.Bar, 55, 0.8));
            TurningExternalTools.Add(new TurningExternalTool(0202, TurningExternalTool.Types.Face, 100, 0.8));
            TurningExternalTools.Add(new TurningExternalTool(0303, TurningExternalTool.Types.Bar, 35, 0.4));
            await localStorage.SetItemAsync(nameof(TurningExternalTools), TurningExternalTools);
        }
        Tools.AddRange(TurningExternalTools);

        TurningInternalTools = await localStorage.GetItemAsync<List<TurningInternalTool>>(nameof(TurningInternalTools));
        if (TurningInternalTools is null || TurningInternalTools.Count == 0)
        {
            TurningInternalTools = new();
            TurningInternalTools.Add(new TurningInternalTool(0202, 25, 55, 0.8));
            TurningInternalTools.Add(new TurningInternalTool(0202, 32, 80, 0.8));
            TurningInternalTools.Add(new TurningInternalTool(0303, 10, 55, 0.4));
            await localStorage.SetItemAsync(nameof(TurningExternalTools), TurningExternalTools);
        }
        Tools.AddRange(TurningInternalTools);
        #endregion

        #region Инициализация канавочного и отрезного инструмента

        GroovingExternalTools = await localStorage.GetItemAsync<List<GroovingExternalTool>>(nameof(GroovingExternalTools));
        if (GroovingExternalTools is null || GroovingExternalTools.Count == 0)
        {
            GroovingExternalTools = new();
            GroovingExternalTools.Add(new GroovingExternalTool(1212, GroovingExternalTool.Types.Grooving, 3, GroovingExternalTool.Point.Left));
            GroovingExternalTools.Add(new GroovingExternalTool(1212, GroovingExternalTool.Types.Cutting, 3, GroovingExternalTool.Point.Right));
            await localStorage.SetItemAsync(nameof(GroovingExternalTools), GroovingExternalTools);
        }
        Tools.AddRange(GroovingExternalTools);

        GroovingInternalTools = await localStorage.GetItemAsync<List<GroovingInternalTool>>(nameof(GroovingInternalTools));
        if (GroovingInternalTools is null || GroovingInternalTools.Count == 0)
        {
            GroovingInternalTools = new();
            GroovingInternalTools.Add(new GroovingInternalTool(1212, 20, 3, GroovingInternalTool.Point.Right));
            GroovingInternalTools.Add(new GroovingInternalTool(1212, 40, 4, GroovingInternalTool.Point.Right));
            await localStorage.SetItemAsync(nameof(GroovingInternalTools), GroovingInternalTools);
        }
        Tools.AddRange(GroovingInternalTools);
        #endregion

        #region Инициализация резьбового инструмента
        ThreadingExternalTools = await localStorage.GetItemAsync<List<ThreadingExternalTool>>(nameof(ThreadingExternalTools));
        if (ThreadingExternalTools is null || TurningExternalTools.Count == 0)
        {
            ThreadingExternalTools = new();
            ThreadingExternalTools.Add(new ThreadingExternalTool(1111, 1.5, 1));
            await localStorage.SetItemAsync(nameof(ThreadingExternalTools), ThreadingExternalTools);
        }
        Tools.AddRange(ThreadingExternalTools);

        ThreadingInternalTools = await localStorage.GetItemAsync<List<ThreadingInternalTool>>(nameof(ThreadingInternalTools));
        if (ThreadingInternalTools is null || ThreadingInternalTools.Count == 0)
        {
            ThreadingInternalTools = new();
            ThreadingInternalTools.Add(new ThreadingInternalTool(1111, 16, 1.5, 1));
            await localStorage.SetItemAsync(nameof(ThreadingInternalTools), ThreadingInternalTools);
        }
        Tools.AddRange(ThreadingInternalTools);
        #endregion

        #region Инициализация сверел
        DrillingTools = await localStorage.GetItemAsync<List<DrillingTool>>(nameof(DrillingTools));
        if (DrillingTools is null || DrillingTools.Count == 0)
        {
            DrillingTools = new();
            DrillingTools.Add(new DrillingTool(0505, DrillingTool.Types.HSS, 5, 120));
            DrillingTools.Add(new DrillingTool(0707, DrillingTool.Types.Solid, 10, 140));
            DrillingTools.Add(new DrillingTool(0606, DrillingTool.Types.Insert, 25, 180));
            await localStorage.SetItemAsync(nameof(DrillingTools), DrillingTools);
        }
        Tools.AddRange(DrillingTools);
        #endregion

        #region Инициализация метчиков
        TappingTools = await localStorage.GetItemAsync<List<TappingTool>>(nameof(TappingTools));
        if (TappingTools is null || TappingTools.Count == 0)
        {
            TappingTools = new();
            TappingTools.Add(new TappingTool(0909, TappingTool.Types.Cutting, 12, 1.75));
            TappingTools.Add(new TappingTool(0808, TappingTool.Types.Forming, 10, 1.5));
            await localStorage.SetItemAsync(nameof(TappingTools), TappingTools);
        }
        Tools.AddRange(TappingTools);
        #endregion

        Program = new();
        Program.Add(new HeaderSequence(Machine, DetailNumber, DetailName, DrawningVersion, string.Empty) { Name = "Шапка"});
        Program.Add(new SafetyStringSequence(Machine, 3000) { Name = "Строка безопасности" });
    }

    private void OpenToolDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(Tools), Tools);
        var options = new DialogOptions() { FullScreen = true, CloseButton = true };
        DialogService.Show<ToolDialog>("Инструмент", parameters, options);
    }

    private void OpenSequencelDialog()
    {
        var parameters = new DialogParameters();
        parameters.Add(nameof(Machine), Machine);
        parameters.Add(nameof(Tools), Tools);
        parameters.Add(nameof(Program), Program);
        parameters.Add(nameof(WorkpieceExternalDiameter), WorkpieceExternalDiameter);
        parameters.Add(nameof(WorkpieceInternalDiameter), WorkpieceInternalDiameter);
        parameters.Add(nameof(WorkpieceLength), WorkpieceLength);
        parameters.Add(nameof(WorkpieceMaterial), WorkpieceMaterial);
        var options = new DialogOptions() { FullScreen = true, CloseButton = true };
        DialogService.Show<SequenceDialog>("Переходы", parameters, options);
        _WorkpieceExternalDiameter += string.Empty;
    }

    public List<Tool> Tools { get; set; } = new();

    public List<TurningExternalTool> TurningExternalTools { get; set; }
    public List<TurningInternalTool> TurningInternalTools { get; set; }
    public List<GroovingExternalTool> GroovingExternalTools { get; set; }
    public List<GroovingInternalTool> GroovingInternalTools { get; set; }
    public List<ThreadingExternalTool> ThreadingExternalTools { get; set; }
    public List<ThreadingInternalTool> ThreadingInternalTools { get; set; }
    public List<DrillingTool> DrillingTools { get; set; }
    public List<TappingTool> TappingTools { get; set; }
    public List<SpecialTool> SpecialTools { get; set; }

    public Materials WorkpieceMaterial { get; set; }
    public Machines Machine { get; set; }

    public string _WorkpieceExternalDiameter { get; set; } = "50";
    public double WorkpieceExternalDiameter { get => Util.GetDouble(_WorkpieceExternalDiameter); }

    public string _WorkpieceInternalDiameter { get; set; } = string.Empty;
    public double WorkpieceInternalDiameter { get => Util.GetDouble(_WorkpieceInternalDiameter); }

    public string DetailNumber { get; set; }

    public string NcDetailNumber { get => $"{DetailNumber.Translate()}.{ OperationNumber.ToString("D1").Replace(",", ".")}S"; }

    public string DetailName { get; set; }
    public string NcDetailName { get => $"{DetailName.Translate()}"; }

    public int OperationNumber { get; set; } = 1;

    public double DrawningVersion { get; set; }

    public string _WorkpieceLength { get; set; } = "50";
    public double WorkpieceLength { get => Util.GetDouble(_WorkpieceLength); }


    //public Sequence Header => new Sequence { Name = "Шапка", Operation = Operation.Header(Machine, NcDetailNumber, NcDetailName, DrawningVersion) };
    //public string Header => Operation.Header(Machine, NcDetailNumber, NcDetailName, DrawningVersion);
    //public Sequence SafetyString => new Sequence { Name = "Строка безопасности", Operation = Operation.SafetyString(Machine, 3000) };
    //public string SafetyString => Operation.SafetyString(Machine, 3000);

    public bool ValidWorkpiece
    {
        get
        {
            if (WorkpieceExternalDiameter > 0 && WorkpieceInternalDiameter < WorkpieceExternalDiameter && WorkpieceLength > 0)
            {
                return true;
            }
            return false;
        }
    }

    public List<Sequence> Program { get; set; }

    public string ProgramText
    {
        get
        {
            if (Program is null) return string.Empty;

            List<string> result = new();
            Message += "1";
            for (int i = 0; i < Program.Count; i++)
            {
                switch (Program[i])
                {
                    case HeaderSequence headerSequence:
                        HeaderSequence newHeaderSequence = Program[i] as HeaderSequence;
                        newHeaderSequence.Machine = Machine;
                        newHeaderSequence.DetailNumber = NcDetailNumber;
                        newHeaderSequence.DetailName = NcDetailName;
                        newHeaderSequence.DrawVersion = DrawningVersion;
                        newHeaderSequence.ToolTable = Util.GetToolTable(Program);
                        Program[i] = newHeaderSequence;
                        break;
                    case SafetyStringSequence safetyStringSequence:
                        SafetyStringSequence newSafetyStringSequence = Program[i] as SafetyStringSequence;
                        newSafetyStringSequence.Machine = Machine;
                        Program[i] = newSafetyStringSequence;
                        break;
                    case LimiterSequence limiterSequence:
                        LimiterSequence newlimiterSequence = Program[i] as LimiterSequence;
                        newlimiterSequence.Machine = Machine;
                        newlimiterSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        Program[i] = newlimiterSequence;
                        break;
                    case FacingSequence facingSequence:
                        FacingSequence newFacingSequence = Program[i] as FacingSequence;
                        newFacingSequence.Machine = Machine;
                        newFacingSequence.Material = WorkpieceMaterial;
                        newFacingSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        newFacingSequence.InternalDiameter = WorkpieceInternalDiameter;
                        Program[i] = newFacingSequence;
                        break;
                    case RoughFacingSequence roughFacingSequence:
                        RoughFacingSequence newRoughFacingSequence = Program[i] as RoughFacingSequence;
                        newRoughFacingSequence.Machine = Machine;
                        newRoughFacingSequence.Material = WorkpieceMaterial;
                        newRoughFacingSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        newRoughFacingSequence.InternalDiameter = WorkpieceInternalDiameter;
                        Program[i] = newRoughFacingSequence;
                        break;
                    case FinishFacingSequence finishFacingSequence:
                        FinishFacingSequence newFinishFacingSequence = Program[i] as FinishFacingSequence;
                        newFinishFacingSequence.Machine = Machine;
                        newFinishFacingSequence.Material = WorkpieceMaterial;
                        newFinishFacingSequence.ExternalDiameter = WorkpieceExternalDiameter;
                        newFinishFacingSequence.InternalDiameter = WorkpieceInternalDiameter;
                        Program[i] = newFinishFacingSequence;
                        break;
                    default:
                        break;
                }
            }

            foreach (var sequence in Program)
            {
                result.Add(sequence.Operation);
            }
            return string.Join("\n", result);
        }
        set { }
    }
}
