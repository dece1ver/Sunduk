<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-3">
    <MudGrid Spacing="1">
        @if (!ValidAngle())
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Warning">Некорректные значения угла!</MudAlert>
            </MudItem>
        }

        <MudItem xs="12" md="6">
            <MudField Label="Градусы в десятичной системе" Variant="Variant.Filled" Underline="false">
                <MudTextField @bind-Value="DecimalAngleString"
                              @onfocusin="@(() => _calcDecimal = false)"
                              T="string"
                              Variant="Variant.Text"
                              Adornment="Adornment.End"
                              AdornmentText="°"
                              Immediate="true" />
            </MudField>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudField Label="Радианы" Variant="Variant.Filled" Underline="false">
                <MudTextField @bind-Value="RadiansAngleString"
                              @onfocusin="@(() => _inputRadians = true)"
                              @onfocusout="@(() => _inputRadians = false)"
                              T="string"
                              Variant="Variant.Text"
                              Adornment="Adornment.End"
                              AdornmentText="rad"
                              Immediate="true" />
            </MudField>
        </MudItem>

        <MudItem xs="12">
            <MudField Label="Градусная система" Variant="Variant.Filled" Underline="false">
                <MudGrid>
                    <MudItem xs="4">
                        <MudTextField @bind-Value="IntAngleString"
                                      @onfocusin="@(() => _calcDecimal = true)"
                                      T="string"
                                      Variant="Variant.Text"
                                      Adornment="Adornment.End"
                                      AdornmentText="°"
                                      Immediate="true" />
                    </MudItem>

                    <MudItem xs="4">
                        <MudTextField @bind-Value="MinAngleString"
                                      @onfocusin="@(() => _calcDecimal = true)"
                                      T="string"
                                      Variant="Variant.Text"
                                      Adornment="Adornment.End"
                                      AdornmentText="′"
                                      Immediate="true" />
                    </MudItem>

                    <MudItem xs="4">
                        <MudTextField @bind-Value="SecAngleString"
                                      @onfocusin="@(() => _calcDecimal = true)"
                                      T="string"
                                      Variant="Variant.Text"
                                      Adornment="Adornment.End"
                                      AdornmentText="″"
                                      Immediate="true" />
                    </MudItem>
                </MudGrid>
            </MudField>
        </MudItem>

    </MudGrid>
</MudContainer>


@code
{
    private const decimal SecondThreshold = 59.9999m;
    private const int MinutesInHour = 60;
    private const int SecondsInMinute = 60;
    private const int SecondsInDegree = 3600;

    private bool _calcDecimal;
    private bool _inputRadians;

    // =====================================
    // ВСПОМОГАТЕЛЬНЫЕ ЧТЕНИЯ
    // =====================================

    private decimal _decimalAngle;
    private decimal _radiansAngle;

    private int _intAngle;
    private int _minAngle;
    private decimal _secAngle;

    // =====================================
    // ДЕСЯТИЧНЫЙ ВВОД
    // =====================================

    private string _decimalAngleString = string.Empty;

    public string DecimalAngleString
    {
        get => _decimalAngleString;
        set
        {
            _decimalAngleString = value ?? string.Empty;

            if (decimal.TryParse(_decimalAngleString.Replace(',', '.'), NumberStyles.Float, CultureInfo.InvariantCulture, out var dec))
            {
                _decimalAngle = dec;
            }
            else
            {
                _decimalAngle = 0m;
            }

            if (!_calcDecimal)
            {
                ConvertDecimalToDms(_decimalAngle, out var d, out var m, out var s);
                _intAngle = d;
                _minAngle = m;
                _secAngle = s;
                _intAngleString = d.ToString(CultureInfo.InvariantCulture);
                _minAngleString = m.ToString(CultureInfo.InvariantCulture);
                _secAngleString = s.ToString("0.####", CultureInfo.InvariantCulture);
            }

            if (!_inputRadians)
            {
                _radiansAngle = _decimalAngle * (decimal)Math.PI / 180m;
                _radiansAngleString = _radiansAngle.ToString("0.####", CultureInfo.InvariantCulture);
            }
        }
    }

    // =====================================
    // РАДИАНЫ
    // =====================================

    private string _radiansAngleString = string.Empty;

    private string RadiansAngleString
    {
        get => _radiansAngleString;
        set
        {
            _radiansAngleString = value ?? string.Empty;

            if (decimal.TryParse(_radiansAngleString.Replace(',', '.'), NumberStyles.Float, CultureInfo.InvariantCulture, out var rad))
            {
                _radiansAngle = rad;
            }
            else
            {
                _radiansAngle = 0m;
            }

            if (_inputRadians)
            {
                _decimalAngle = _radiansAngle * 180m / (decimal)Math.PI;
                _decimalAngleString = _decimalAngle.ToString("0.####", CultureInfo.InvariantCulture);
            }

            if (!_calcDecimal)
            {
                ConvertDecimalToDms(_decimalAngle, out var d, out var m, out var s);
                _intAngle = d;
                _minAngle = m;
                _secAngle = s;
                _intAngleString = d.ToString(CultureInfo.InvariantCulture);
                _minAngleString = m.ToString(CultureInfo.InvariantCulture);
                _secAngleString = s.ToString("0.####", CultureInfo.InvariantCulture);
            }
        }
    }

    // =====================================
    // ГРАДУСНАЯ СИСТЕМА (DMS)
    // =====================================

    private string _intAngleString = string.Empty;

    public string IntAngleString
    {
        get => _intAngleString;
        set
        {
            _intAngleString = value ?? string.Empty;

            if (int.TryParse(_intAngleString, NumberStyles.Integer, CultureInfo.InvariantCulture, out var intVal))
            {
                _intAngle = intVal;
            }
            else
            {
                _intAngle = 0;
            }

            UpdateDecimalFromDms();
        }
    }

    private string _minAngleString = string.Empty;

    public string MinAngleString
    {
        get => _minAngleString;
        set
        {
            _minAngleString = value ?? string.Empty;

            if (int.TryParse(_minAngleString, NumberStyles.Integer, CultureInfo.InvariantCulture, out var minVal))
            {
                _minAngle = minVal;
            }
            else
            {
                _minAngle = 0;
            }

            UpdateDecimalFromDms();
        }
    }

    private string _secAngleString = string.Empty;

    public string SecAngleString
    {
        get => _secAngleString;
        set
        {
            _secAngleString = value ?? string.Empty;

            if (decimal.TryParse(_secAngleString.Replace(',', '.'), NumberStyles.Float, CultureInfo.InvariantCulture, out var secVal))
            {
                _secAngle = secVal;
            }
            else
            {
                _secAngle = 0m;
            }

            UpdateDecimalFromDms();
        }
    }

    private void UpdateDecimalFromDms()
    {
        if (!_calcDecimal || !ValidAngle())
        {
            return;
        }

        var dec = ConvertDmsToDecimal(_intAngle, _minAngle, _secAngle);
        _decimalAngle = dec;
        _decimalAngleString = dec.ToString("0.####", CultureInfo.InvariantCulture);

        _radiansAngle = _decimalAngle * (decimal)Math.PI / 180m;
        _radiansAngleString = _radiansAngle.ToString("0.####", CultureInfo.InvariantCulture);
    }

    private bool ValidAngle() =>
        _minAngle >= 0 && _minAngle < MinutesInHour &&
        _secAngle >= 0 && _secAngle < SecondsInMinute;

    // =====================================
    // ЛОГИКА КОНВЕРТАЦИИ
    // =====================================

    private static decimal ConvertDmsToDecimal(int d, int m, decimal s)
        => d + (m / 60m) + (s / 3600m);

    private static void ConvertDecimalToDms(decimal dec, out int deg, out int min, out decimal sec)
    {
        var total = dec * SecondsInDegree;

        deg = (int)(total / SecondsInDegree);
        total -= deg * SecondsInDegree;

        min = (int)(total / SecondsInMinute);
        total -= min * SecondsInMinute;

        sec = total;

        NormalizeDms(ref deg, ref min, ref sec);
    }

    private static void NormalizeDms(ref int deg, ref int min, ref decimal sec)
    {
        if (sec >= SecondThreshold)
        {
            sec = 0;
            min++;
        }

        if (min == MinutesInHour)
        {
            min = 0;
            deg++;
        }
    }
}